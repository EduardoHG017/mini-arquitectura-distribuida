name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        working-directory: ./app
        run: npm install

      - name: Run tests
        working-directory: ./app
        run: npm test

      - name: Verify code quality (JSON structure)
        working-directory: ./app/pages/api
        run: |
          node -e "
          const handler = require('./procesar.js').default;
          const mockRes = {
            statusCode: null,
            body: null,
            status(code) { this.statusCode = code; return this; },
            json(payload) { this.body = payload; return this; }
          };
          handler({ query: { nombre: 'test' } }, mockRes);
          if (!mockRes.body.resultado || !mockRes.body.timestamp) {
            throw new Error('Invalid response structure');
          }
          console.log('âœ“ Response structure is valid');
          "
